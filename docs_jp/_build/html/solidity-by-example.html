

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Solidity by Example &mdash; Solidity 0.5.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Solidity in Depth" href="solidity-in-depth.html" />
    <link rel="prev" title="Installing the Solidity Compiler" href="installing-solidity.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Solidity
          

          
          </a>

          
            
            
              <div class="version">
                0.5.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction-to-smart-contracts.html">Introduction to Smart Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing-solidity.html">Installing the Solidity Compiler</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Solidity by Example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#voting">Voting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blind-auction">Blind Auction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#simple-open-auction">Simple Open Auction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Blind Auction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#safe-remote-purchase">Safe Remote Purchase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#micropayment-channel">Micropayment Channel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-and-verifying-signatures">Creating and verifying signatures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-signature">Creating the signature</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-to-sign">What to Sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="#packing-arguments">Packing arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#recovering-the-message-signer-in-solidity">Recovering the Message Signer in Solidity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extracting-the-signature-parameters">Extracting the Signature Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#computing-the-message-hash">Computing the Message Hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-full-contract">The full contract</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-a-simple-payment-channel">Writing a Simple Payment Channel</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-a-payment-channel">What is a Payment Channel?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opening-the-payment-channel">Opening the Payment Channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#making-payments">Making Payments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#closing-the-payment-channel">Closing the Payment Channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#channel-expiration">Channel Expiration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">The full contract</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verifying-payments">Verifying Payments</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="solidity-in-depth.html">Solidity in Depth</a></li>
<li class="toctree-l1"><a class="reference internal" href="security-considerations.html">Security Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-the-compiler.html">Using the compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">コントラクトメタデータ</a></li>
<li class="toctree-l1"><a class="reference internal" href="abi-spec.html">Contract ABI Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="yul.html">Yul</a></li>
<li class="toctree-l1"><a class="reference internal" href="style-guide.html">Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="common-patterns.html">Common Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="bugs.html">既知のバグ</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="frequently-asked-questions.html">よくある質問</a></li>
<li class="toctree-l1"><a class="reference internal" href="lll.html">LLL</a></li>
</ul>

            
          
    <a href="genindex.html">Keyword Index</a>
  
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Solidity</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Solidity by Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/solidity-by-example.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="solidity-by-example">
<h1>Solidity by Example<a class="headerlink" href="#solidity-by-example" title="Permalink to this headline">¶</a></h1>
<div class="section" id="voting">
<span id="index-0"></span><span id="id1"></span><h2>Voting<a class="headerlink" href="#voting" title="Permalink to this headline">¶</a></h2>
<p>次のコントラクトは割と複雑ですが、Solidityのたくさんの機能を表しています。そのコントラクトは投票を実行しています。もちろん、電子投票のメインの問題はどうやって投票権を正しい人に渡すのかということと、どうやって不正操作を防ぐかです。ここでは全ての問題を解決はしませんが、投票がどの様に行われ、そして**自動かつ公正な**投票数のカウントの方法をお見せします。</p>
<p>そのアイデアとは投票ごとにコントラクトを作り、オプションごとに短い名前をつけるものです。そしてコントラクトの作成者は管理者として各アドレスに投票の権利を付与します。</p>
<p>そのアドレスを持っている人は自分で投票するか、投票の権利を信頼している人に譲渡することもできます。</p>
<p>投票の最後に、<code class="docutils literal notranslate"><span class="pre">winningProposal()</span></code> は現在の最高投票数を獲得している人を表示します。</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">22</span> <span class="o">&lt;</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">/// </span><span class="cs">@title</span><span class="c1"> Voting with delegation.</span>
<span class="kd">contract</span> <span class="n">Ballot</span> <span class="p">{</span>
    <span class="c1">// This declares a new complex type which will</span>
    <span class="c1">// be used for variables later.</span>
    <span class="c1">// It will represent a single voter.</span>
    <span class="kd">struct</span> <span class="n">Voter</span> <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">weight</span><span class="p">;</span> <span class="c1">// weight is accumulated by delegation</span>
        <span class="kt">bool</span> <span class="n">voted</span><span class="p">;</span>  <span class="c1">// if true, that person already voted</span>
        <span class="kt">address</span> <span class="n">delegate</span><span class="p">;</span> <span class="c1">// person delegated to</span>
        <span class="kt">uint</span> <span class="n">vote</span><span class="p">;</span>   <span class="c1">// index of the voted proposal</span>
    <span class="p">}</span>

    <span class="c1">// This is a type for a single proposal.</span>
    <span class="kd">struct</span> <span class="n">Proposal</span> <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">name</span><span class="p">;</span>   <span class="c1">// short name (up to 32 bytes)</span>
        <span class="kt">uint</span> <span class="n">voteCount</span><span class="p">;</span> <span class="c1">// number of accumulated votes</span>
    <span class="p">}</span>

    <span class="kt">address</span> <span class="kr">public</span> <span class="n">chairperson</span><span class="p">;</span>

    <span class="c1">// This declares a state variable that</span>
    <span class="c1">// stores a `Voter` struct for each possible address.</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="n">Voter</span><span class="p">)</span> <span class="kr">public</span> <span class="n">voters</span><span class="p">;</span>

    <span class="c1">// A dynamically-sized array of `Proposal` structs.</span>
    <span class="n">Proposal</span><span class="p">[]</span> <span class="kr">public</span> <span class="n">proposals</span><span class="p">;</span>

    <span class="c1">/// Create a new ballot to choose one of `proposalNames`.</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="kt">bytes32</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">proposalNames</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">chairperson</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">voters</span><span class="p">[</span><span class="n">chairperson</span><span class="p">].</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="c1">// For each of the provided proposal names,</span>
        <span class="c1">// create a new proposal object and add it</span>
        <span class="c1">// to the end of the array.</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">proposalNames</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// `Proposal({...})` creates a temporary</span>
            <span class="c1">// Proposal object and `proposals.push(...)`</span>
            <span class="c1">// appends it to the end of `proposals`.</span>
            <span class="n">proposals</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">Proposal</span><span class="p">({</span>
                <span class="n">name</span><span class="o">:</span> <span class="n">proposalNames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">voteCount</span><span class="o">:</span> <span class="mi">0</span>
            <span class="p">}));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Give `voter` the right to vote on this ballot.</span>
    <span class="c1">// May only be called by `chairperson`.</span>
    <span class="kd">function</span> <span class="n">giveRightToVote</span><span class="p">(</span><span class="kt">address</span> <span class="n">voter</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// If the first argument of `require` evaluates</span>
        <span class="c1">// to `false`, execution terminates and all</span>
        <span class="c1">// changes to the state and to Ether balances</span>
        <span class="c1">// are reverted.</span>
        <span class="c1">// This used to consume all gas in old EVM versions, but</span>
        <span class="c1">// not anymore.</span>
        <span class="c1">// It is often a good idea to use `require` to check if</span>
        <span class="c1">// functions are called correctly.</span>
        <span class="c1">// As a second argument, you can also provide an</span>
        <span class="c1">// explanation about what went wrong.</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">chairperson</span><span class="p">,</span>
            <span class="s">&quot;Only chairperson can give right to vote.&quot;</span>
        <span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="o">!</span><span class="n">voters</span><span class="p">[</span><span class="n">voter</span><span class="p">].</span><span class="n">voted</span><span class="p">,</span>
            <span class="s">&quot;The voter already voted.&quot;</span>
        <span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">voters</span><span class="p">[</span><span class="n">voter</span><span class="p">].</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">voters</span><span class="p">[</span><span class="n">voter</span><span class="p">].</span><span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Delegate your vote to the voter `to`.</span>
    <span class="kd">function</span> <span class="n">delegate</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// assigns reference</span>
        <span class="n">Voter</span> <span class="kr">storage</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">sender</span><span class="p">.</span><span class="n">voted</span><span class="p">,</span> <span class="s">&quot;You already voted.&quot;</span><span class="p">);</span>

        <span class="nf">require</span><span class="p">(</span><span class="n">to</span> <span class="o">!=</span> <span class="nb">msg.sender</span><span class="p">,</span> <span class="s">&quot;Self-delegation is disallowed.&quot;</span><span class="p">);</span>

        <span class="c1">// Forward the delegation as long as</span>
        <span class="c1">// `to` also delegated.</span>
        <span class="c1">// In general, such loops are very dangerous,</span>
        <span class="c1">// because if they run too long, they might</span>
        <span class="c1">// need more gas than is available in a block.</span>
        <span class="c1">// In this case, the delegation will not be executed,</span>
        <span class="c1">// but in other situations, such loops might</span>
        <span class="c1">// cause a contract to get &quot;stuck&quot; completely.</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">voters</span><span class="p">[</span><span class="n">to</span><span class="p">].</span><span class="n">delegate</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">to</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="n">to</span><span class="p">].</span><span class="n">delegate</span><span class="p">;</span>

            <span class="c1">// We found a loop in the delegation, not allowed.</span>
            <span class="nf">require</span><span class="p">(</span><span class="n">to</span> <span class="o">!=</span> <span class="nb">msg.sender</span><span class="p">,</span> <span class="s">&quot;Found loop in delegation.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Since `sender` is a reference, this</span>
        <span class="c1">// modifies `voters[msg.sender].voted`</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">voted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
        <span class="n">Voter</span> <span class="kr">storage</span> <span class="n">delegate_</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="n">to</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">delegate_</span><span class="p">.</span><span class="n">voted</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If the delegate already voted,</span>
            <span class="c1">// directly add to the number of votes</span>
            <span class="n">proposals</span><span class="p">[</span><span class="n">delegate_</span><span class="p">.</span><span class="n">vote</span><span class="p">].</span><span class="n">voteCount</span> <span class="o">+=</span> <span class="n">sender</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// If the delegate did not vote yet,</span>
            <span class="c1">// add to her weight.</span>
            <span class="n">delegate_</span><span class="p">.</span><span class="n">weight</span> <span class="o">+=</span> <span class="n">sender</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// Give your vote (including votes delegated to you)</span>
    <span class="c1">/// to proposal `proposals[proposal].name`.</span>
    <span class="kd">function</span> <span class="n">vote</span><span class="p">(</span><span class="kt">uint</span> <span class="n">proposal</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">Voter</span> <span class="kr">storage</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">voters</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">sender</span><span class="p">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Has no right to vote&quot;</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">sender</span><span class="p">.</span><span class="n">voted</span><span class="p">,</span> <span class="s">&quot;Already voted.&quot;</span><span class="p">);</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">voted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">vote</span> <span class="o">=</span> <span class="n">proposal</span><span class="p">;</span>

        <span class="c1">// If `proposal` is out of the range of the array,</span>
        <span class="c1">// this will throw automatically and revert all</span>
        <span class="c1">// changes.</span>
        <span class="n">proposals</span><span class="p">[</span><span class="n">proposal</span><span class="p">].</span><span class="n">voteCount</span> <span class="o">+=</span> <span class="n">sender</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// </span><span class="cs">@dev</span><span class="c1"> Computes the winning proposal taking all</span>
    <span class="c1">/// previous votes into account.</span>
    <span class="kd">function</span> <span class="n">winningProposal</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">view</span>
            <span class="k">returns</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">winningProposal_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">winningVoteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">proposals</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">proposals</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">voteCount</span> <span class="o">&gt;</span> <span class="n">winningVoteCount</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">winningVoteCount</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">voteCount</span><span class="p">;</span>
                <span class="n">winningProposal_</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Calls winningProposal() function to get the index</span>
    <span class="c1">// of the winner contained in the proposals array and then</span>
    <span class="c1">// returns the name of the winner</span>
    <span class="kd">function</span> <span class="n">winnerName</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">view</span>
            <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span> <span class="n">winnerName_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">winnerName_</span> <span class="o">=</span> <span class="n">proposals</span><span class="p">[</span><span class="n">winningProposal</span><span class="p">()].</span><span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="blind-auction">
<span id="index-1"></span><h2>Blind Auction<a class="headerlink" href="#blind-auction" title="Permalink to this headline">¶</a></h2>
<p>このセクションではEthereum上で完全なブラインドオークションを作成するのがいかに簡単かお見せします。</p>
<div class="section" id="simple-open-auction">
<span id="simple-auction"></span><h3>Simple Open Auction<a class="headerlink" href="#simple-open-auction" title="Permalink to this headline">¶</a></h3>
<p>全員が期間内に入札できるというのが次の単純なオークションのコントラクトの大まかな考え方です。オークション参加者が入札を取り消すことが無いようにするために入札はお金/etherを既に含んでいます。もし最高額が更新されたらその前の最高額を入札していた人に返金します。入札の金額の受領者がお金を受け取るために、コントラクトは入札期間終了後にマニュアルで呼び出されなければいけません。コントラクトは自動でこれを行えません。</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">22</span> <span class="o">&lt;</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">SimpleAuction</span> <span class="p">{</span>
    <span class="c1">// Parameters of the auction. Times are either</span>
    <span class="c1">// absolute unix timestamps (seconds since 1970-01-01)</span>
    <span class="c1">// or time periods in seconds.</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">beneficiary</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">auctionEndTime</span><span class="p">;</span>

    <span class="c1">// Current state of the auction.</span>
    <span class="kt">address</span> <span class="kr">public</span> <span class="n">highestBidder</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">highestBid</span><span class="p">;</span>

    <span class="c1">// Allowed withdrawals of previous bids</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="n">pendingReturns</span><span class="p">;</span>

    <span class="c1">// Set to true at the end, disallows any change.</span>
    <span class="c1">// By default initialized to `false`.</span>
    <span class="kt">bool</span> <span class="n">ended</span><span class="p">;</span>

    <span class="c1">// Events that will be emitted on changes.</span>
    <span class="kd">event</span> <span class="n">HighestBidIncreased</span><span class="p">(</span><span class="kt">address</span> <span class="n">bidder</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>
    <span class="kd">event</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="kt">address</span> <span class="n">winner</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">);</span>

    <span class="c1">// The following is a so-called natspec comment,</span>
    <span class="c1">// recognizable by the three slashes.</span>
    <span class="c1">// It will be shown when the user is asked to</span>
    <span class="c1">// confirm a transaction.</span>

    <span class="c1">/// Create a simple auction with `_biddingTime`</span>
    <span class="c1">/// seconds bidding time on behalf of the</span>
    <span class="c1">/// beneficiary address `_beneficiary`.</span>
    <span class="kd">constructor</span><span class="p">(</span>
        <span class="kt">uint</span> <span class="n">_biddingTime</span><span class="p">,</span>
        <span class="kt">address</span> <span class="kr">payable</span> <span class="n">_beneficiary</span>
    <span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">beneficiary</span> <span class="o">=</span> <span class="n">_beneficiary</span><span class="p">;</span>
        <span class="n">auctionEndTime</span> <span class="o">=</span> <span class="nb">now</span> <span class="o">+</span> <span class="n">_biddingTime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Bid on the auction with the value sent</span>
    <span class="c1">/// together with this transaction.</span>
    <span class="c1">/// The value will only be refunded if the</span>
    <span class="c1">/// auction is not won.</span>
    <span class="kd">function</span> <span class="n">bid</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="c1">// No arguments are necessary, all</span>
        <span class="c1">// information is already part of</span>
        <span class="c1">// the transaction. The keyword payable</span>
        <span class="c1">// is required for the function to</span>
        <span class="c1">// be able to receive Ether.</span>

        <span class="c1">// Revert the call if the bidding</span>
        <span class="c1">// period is over.</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">now</span> <span class="o">&lt;=</span> <span class="n">auctionEndTime</span><span class="p">,</span>
            <span class="s">&quot;Auction already ended.&quot;</span>
        <span class="p">);</span>

        <span class="c1">// If the bid is not higher, send the</span>
        <span class="c1">// money back.</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.value</span> <span class="o">&gt;</span> <span class="n">highestBid</span><span class="p">,</span>
            <span class="s">&quot;There already is a higher bid.&quot;</span>
        <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">highestBid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Sending back the money by simply using</span>
            <span class="c1">// highestBidder.send(highestBid) is a security risk</span>
            <span class="c1">// because it could execute an untrusted contract.</span>
            <span class="c1">// It is always safer to let the recipients</span>
            <span class="c1">// withdraw their money themselves.</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="n">highestBidder</span><span class="p">]</span> <span class="o">+=</span> <span class="n">highestBid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">highestBidder</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">highestBid</span> <span class="o">=</span> <span class="nb">msg.value</span><span class="p">;</span>
        <span class="kr">emit</span> <span class="n">HighestBidIncreased</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="nb">msg.value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// Withdraw a bid that was overbid.</span>
    <span class="kd">function</span> <span class="n">withdraw</span><span class="p">()</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// It is important to set this to zero because the recipient</span>
            <span class="c1">// can call this function again as part of the receiving call</span>
            <span class="c1">// before `send` returns.</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">msg.sender</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// No need to call throw here, just reset the amount owing</span>
                <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span><span class="p">;</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// End the auction and send the highest bid</span>
    <span class="c1">/// to the beneficiary.</span>
    <span class="kd">function</span> <span class="n">auctionEnd</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="c1">// It is a good guideline to structure functions that interact</span>
        <span class="c1">// with other contracts (i.e. they call functions or send Ether)</span>
        <span class="c1">// into three phases:</span>
        <span class="c1">// 1. checking conditions</span>
        <span class="c1">// 2. performing actions (potentially changing conditions)</span>
        <span class="c1">// 3. interacting with other contracts</span>
        <span class="c1">// If these phases are mixed up, the other contract could call</span>
        <span class="c1">// back into the current contract and modify the state or cause</span>
        <span class="c1">// effects (ether payout) to be performed multiple times.</span>
        <span class="c1">// If functions called internally include interaction with external</span>
        <span class="c1">// contracts, they also have to be considered interaction with</span>
        <span class="c1">// external contracts.</span>

        <span class="c1">// 1. Conditions</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&gt;=</span> <span class="n">auctionEndTime</span><span class="p">,</span> <span class="s">&quot;Auction not yet ended.&quot;</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">ended</span><span class="p">,</span> <span class="s">&quot;auctionEnd has already been called.&quot;</span><span class="p">);</span>

        <span class="c1">// 2. Effects</span>
        <span class="n">ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="kr">emit</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="n">highestBidder</span><span class="p">,</span> <span class="n">highestBid</span><span class="p">);</span>

        <span class="c1">// 3. Interaction</span>
        <span class="n">beneficiary</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">highestBid</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Blind Auction<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>前のオープンオークションを次はブラインドオークションに拡張します。ブラインドオークションのメリットは入札期限間際の時間に対するプレッシャーが無いことです。ブラインドオークションを誰からも見れるプラットフォームで行うというのは変な感じがしますが、暗号学が助けてくれます。</p>
<p><strong>入札期間</strong> に入札者は実際に入札を行いません。しかし、ハッシュ化されたものだけ送ります。現在、（十分に長い）二つのハッシュ値が同じ値を見つけるのは実用上不可能なので、入札者はその入札値を変更することはできません。
入札期間の終了後入札者は入札値を公開する必要があります。暗号化されていない値を送り、コントラクトはその値をハッシュ化したものが入札期間に送られたハッシュ値と同じか確認します。</p>
<p>もう一つの問題はどうやってオークションに <strong>強制力を持たせ、かつブラインド</strong> にするかです。落札した入札者が送金しないことを防ぐ唯一の方法は入札時にお金を支払わせることです。Ethereumでは送金はオープンなので誰でも金額を見ることができます。</p>
<p>次のコントラクトではこの問題を最高額の入札以上のどんな値でも受け入れることで解決しています。もちろんこれは値が公開された時にしか行えないので、いくつかの入札は無効の可能性があり、かつそれは故意的な可能性もあります（高額送金を伴った無効な入札をするために明らかなフラグを立てることもあります）。入札者は高いもしくは低い入札で他の入札者を混乱させることができます。</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">23</span> <span class="o">&lt;</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">BlindAuction</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="n">Bid</span> <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">blindedBid</span><span class="p">;</span>
        <span class="kt">uint</span> <span class="n">deposit</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">beneficiary</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">biddingEnd</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">revealEnd</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="kr">public</span> <span class="n">ended</span><span class="p">;</span>

    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="n">Bid</span><span class="p">[])</span> <span class="kr">public</span> <span class="n">bids</span><span class="p">;</span>

    <span class="kt">address</span> <span class="kr">public</span> <span class="n">highestBidder</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">highestBid</span><span class="p">;</span>

    <span class="c1">// Allowed withdrawals of previous bids</span>
    <span class="kd">mapping</span><span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="n">pendingReturns</span><span class="p">;</span>

    <span class="kd">event</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="kt">address</span> <span class="n">winner</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">highestBid</span><span class="p">);</span>

    <span class="c1">/// Modifiers are a convenient way to validate inputs to</span>
    <span class="c1">/// functions. `onlyBefore` is applied to `bid` below:</span>
    <span class="c1">/// The new function body is the modifier&#39;s body where</span>
    <span class="c1">/// `_` is replaced by the old function body.</span>
    <span class="kd">modifier</span> <span class="n">onlyBefore</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_time</span><span class="p">)</span> <span class="p">{</span> <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&lt;</span> <span class="n">_time</span><span class="p">);</span> <span class="kr">_</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">modifier</span> <span class="n">onlyAfter</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_time</span><span class="p">)</span> <span class="p">{</span> <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&gt;</span> <span class="n">_time</span><span class="p">);</span> <span class="kr">_</span><span class="p">;</span> <span class="p">}</span>

    <span class="kd">constructor</span><span class="p">(</span>
        <span class="kt">uint</span> <span class="n">_biddingTime</span><span class="p">,</span>
        <span class="kt">uint</span> <span class="n">_revealTime</span><span class="p">,</span>
        <span class="kt">address</span> <span class="kr">payable</span> <span class="n">_beneficiary</span>
    <span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">beneficiary</span> <span class="o">=</span> <span class="n">_beneficiary</span><span class="p">;</span>
        <span class="n">biddingEnd</span> <span class="o">=</span> <span class="nb">now</span> <span class="o">+</span> <span class="n">_biddingTime</span><span class="p">;</span>
        <span class="n">revealEnd</span> <span class="o">=</span> <span class="n">biddingEnd</span> <span class="o">+</span> <span class="n">_revealTime</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Place a blinded bid with `_blindedBid` =</span>
    <span class="c1">/// keccak256(abi.encodePacked(value, fake, secret)).</span>
    <span class="c1">/// The sent ether is only refunded if the bid is correctly</span>
    <span class="c1">/// revealed in the revealing phase. The bid is valid if the</span>
    <span class="c1">/// ether sent together with the bid is at least &quot;value&quot; and</span>
    <span class="c1">/// &quot;fake&quot; is not true. Setting &quot;fake&quot; to true and sending</span>
    <span class="c1">/// not the exact amount are ways to hide the real bid but</span>
    <span class="c1">/// still make the required deposit. The same address can</span>
    <span class="c1">/// place multiple bids.</span>
    <span class="kd">function</span> <span class="n">bid</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_blindedBid</span><span class="p">)</span>
        <span class="kr">public</span>
        <span class="kr">payable</span>
        <span class="n">onlyBefore</span><span class="p">(</span><span class="n">biddingEnd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">bids</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">].</span><span class="nf">push</span><span class="p">(</span><span class="n">Bid</span><span class="p">({</span>
            <span class="n">blindedBid</span><span class="o">:</span> <span class="n">_blindedBid</span><span class="p">,</span>
            <span class="n">deposit</span><span class="o">:</span> <span class="nb">msg.value</span>
        <span class="p">}));</span>
    <span class="p">}</span>

    <span class="c1">/// Reveal your blinded bids. You will get a refund for all</span>
    <span class="c1">/// correctly blinded invalid bids and for all bids except for</span>
    <span class="c1">/// the totally highest.</span>
    <span class="kd">function</span> <span class="n">reveal</span><span class="p">(</span>
        <span class="kt">uint</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">_values</span><span class="p">,</span>
        <span class="kt">bool</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">_fake</span><span class="p">,</span>
        <span class="kt">bytes32</span><span class="p">[]</span> <span class="kr">memory</span> <span class="n">_secret</span>
    <span class="p">)</span>
        <span class="kr">public</span>
        <span class="n">onlyAfter</span><span class="p">(</span><span class="n">biddingEnd</span><span class="p">)</span>
        <span class="n">onlyBefore</span><span class="p">(</span><span class="n">revealEnd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">length</span> <span class="o">=</span> <span class="n">bids</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">].</span><span class="n">length</span><span class="p">;</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_values</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">length</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_fake</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">length</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_secret</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="n">length</span><span class="p">);</span>

        <span class="kt">uint</span> <span class="n">refund</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Bid</span> <span class="kr">storage</span> <span class="n">bidToCheck</span> <span class="o">=</span> <span class="n">bids</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
            <span class="p">(</span><span class="kt">uint</span> <span class="n">value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">fake</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">secret</span><span class="p">)</span> <span class="o">=</span>
                    <span class="p">(</span><span class="n">_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_fake</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_secret</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bidToCheck</span><span class="p">.</span><span class="n">blindedBid</span> <span class="o">!=</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fake</span><span class="p">,</span> <span class="n">secret</span><span class="p">)))</span> <span class="p">{</span>
                <span class="c1">// Bid was not actually revealed.</span>
                <span class="c1">// Do not refund deposit.</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">refund</span> <span class="o">+=</span> <span class="n">bidToCheck</span><span class="p">.</span><span class="n">deposit</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fake</span> <span class="o">&amp;&amp;</span> <span class="n">bidToCheck</span><span class="p">.</span><span class="n">deposit</span> <span class="o">&gt;=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">placeBid</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="n">refund</span> <span class="o">-=</span> <span class="n">value</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// Make it impossible for the sender to re-claim</span>
            <span class="c1">// the same deposit.</span>
            <span class="n">bidToCheck</span><span class="p">.</span><span class="n">blindedBid</span> <span class="o">=</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">msg.sender</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">refund</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// This is an &quot;internal&quot; function which means that it</span>
    <span class="c1">// can only be called from the contract itself (or from</span>
    <span class="c1">// derived contracts).</span>
    <span class="kd">function</span> <span class="n">placeBid</span><span class="p">(</span><span class="kt">address</span> <span class="n">bidder</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">value</span><span class="p">)</span> <span class="kr">internal</span>
            <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">highestBid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">highestBidder</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Refund the previously highest bidder.</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="n">highestBidder</span><span class="p">]</span> <span class="o">+=</span> <span class="n">highestBid</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">highestBid</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="n">highestBidder</span> <span class="o">=</span> <span class="n">bidder</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Withdraw a bid that was overbid.</span>
    <span class="kd">function</span> <span class="n">withdraw</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="kt">uint</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// It is important to set this to zero because the recipient</span>
            <span class="c1">// can call this function again as part of the receiving call</span>
            <span class="c1">// before `transfer` returns (see the remark above about</span>
            <span class="c1">// conditions -&gt; effects -&gt; interaction).</span>
            <span class="n">pendingReturns</span><span class="p">[</span><span class="nb">msg.sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="nb">msg.sender</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// End the auction and send the highest bid</span>
    <span class="c1">/// to the beneficiary.</span>
    <span class="kd">function</span> <span class="n">auctionEnd</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">onlyAfter</span><span class="p">(</span><span class="n">revealEnd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">ended</span><span class="p">);</span>
        <span class="kr">emit</span> <span class="n">AuctionEnded</span><span class="p">(</span><span class="n">highestBidder</span><span class="p">,</span> <span class="n">highestBid</span><span class="p">);</span>
        <span class="n">ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="n">beneficiary</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">highestBid</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="safe-remote-purchase">
<span id="index-2"></span><h2>Safe Remote Purchase<a class="headerlink" href="#safe-remote-purchase" title="Permalink to this headline">¶</a></h2>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">22</span> <span class="o">&lt;</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">Purchase</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="n">value</span><span class="p">;</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">seller</span><span class="p">;</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">buyer</span><span class="p">;</span>
    <span class="kd">enum</span> <span class="n">State</span> <span class="p">{</span> <span class="n">Created</span><span class="p">,</span> <span class="n">Locked</span><span class="p">,</span> <span class="n">Inactive</span> <span class="p">}</span>
    <span class="n">State</span> <span class="kr">public</span> <span class="n">state</span><span class="p">;</span>

    <span class="c1">// Ensure that `msg.value` is an even number.</span>
    <span class="c1">// Division will truncate if it is an odd number.</span>
    <span class="c1">// Check via multiplication that it wasn&#39;t an odd number.</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="n">seller</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">msg.value</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nf">require</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">msg.value</span><span class="p">,</span> <span class="s">&quot;Value has to be even.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">condition</span><span class="p">(</span><span class="kt">bool</span> <span class="n">_condition</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">_condition</span><span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">onlyBuyer</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">buyer</span><span class="p">,</span>
            <span class="s">&quot;Only buyer can call this.&quot;</span>
        <span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">onlySeller</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">seller</span><span class="p">,</span>
            <span class="s">&quot;Only seller can call this.&quot;</span>
        <span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">modifier</span> <span class="n">inState</span><span class="p">(</span><span class="n">State</span> <span class="n">_state</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span>
            <span class="n">state</span> <span class="o">==</span> <span class="n">_state</span><span class="p">,</span>
            <span class="s">&quot;Invalid state.&quot;</span>
        <span class="p">);</span>
        <span class="kr">_</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">event</span> <span class="n">Aborted</span><span class="p">();</span>
    <span class="kd">event</span> <span class="n">PurchaseConfirmed</span><span class="p">();</span>
    <span class="kd">event</span> <span class="n">ItemReceived</span><span class="p">();</span>

    <span class="c1">/// Abort the purchase and reclaim the ether.</span>
    <span class="c1">/// Can only be called by the seller before</span>
    <span class="c1">/// the contract is locked.</span>
    <span class="kd">function</span> <span class="n">abort</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">onlySeller</span>
        <span class="n">inState</span><span class="p">(</span><span class="n">State</span><span class="p">.</span><span class="n">Created</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kr">emit</span> <span class="n">Aborted</span><span class="p">();</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Inactive</span><span class="p">;</span>
        <span class="n">seller</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// Confirm the purchase as buyer.</span>
    <span class="c1">/// Transaction has to include `2 * value` ether.</span>
    <span class="c1">/// The ether will be locked until confirmReceived</span>
    <span class="c1">/// is called.</span>
    <span class="kd">function</span> <span class="n">confirmPurchase</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">inState</span><span class="p">(</span><span class="n">State</span><span class="p">.</span><span class="n">Created</span><span class="p">)</span>
        <span class="n">condition</span><span class="p">(</span><span class="nb">msg.value</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">value</span><span class="p">))</span>
        <span class="kr">payable</span>
    <span class="p">{</span>
        <span class="kr">emit</span> <span class="n">PurchaseConfirmed</span><span class="p">();</span>
        <span class="n">buyer</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Locked</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// Confirm that you (the buyer) received the item.</span>
    <span class="c1">/// This will release the locked ether.</span>
    <span class="kd">function</span> <span class="n">confirmReceived</span><span class="p">()</span>
        <span class="kr">public</span>
        <span class="n">onlyBuyer</span>
        <span class="n">inState</span><span class="p">(</span><span class="n">State</span><span class="p">.</span><span class="n">Locked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kr">emit</span> <span class="n">ItemReceived</span><span class="p">();</span>
        <span class="c1">// It is important to change the state first because</span>
        <span class="c1">// otherwise, the contracts called using `send` below</span>
        <span class="c1">// can call in again here.</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Inactive</span><span class="p">;</span>

        <span class="c1">// NOTE: This actually allows both the buyer and the seller to</span>
        <span class="c1">// block the refund - the withdraw pattern should be used.</span>

        <span class="n">buyer</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
        <span class="n">seller</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="micropayment-channel">
<h2>Micropayment Channel<a class="headerlink" href="#micropayment-channel" title="Permalink to this headline">¶</a></h2>
<p>このセクションではペイメントチャンネルの実行をどうやって行うかを学びます。ここでは同じ人の間で繰り返し行われるEtherの送金を安全、高速かつトランザクションの手数料なしに行うために暗号化された署名を使います。
この例では、どの様に署名、検証し、そしてどの様にペイメントチャンネルをセットアップするかを理解する必要があります。</p>
<div class="section" id="creating-and-verifying-signatures">
<h3>Creating and verifying signatures<a class="headerlink" href="#creating-and-verifying-signatures" title="Permalink to this headline">¶</a></h3>
<p>アリスがボブにある量のEtherを送りたいという状況を想像してください。</p>
<p>アリスは暗号学的に署名されたメッセージをオフチェーン（例えばEメール）でボブに送る必要があります。これはチェックを書く時に似ています。</p>
<p>アリスとボブはトランザクションを許可するために署名を使います。これはEthereum上のスマートコントラクトで可能です。
アリスはEtherを送るシンプルなスマートコントラクトを作りました。しかし、その送金を始めるためのファンクションの呼び出しを自分で行う代わりに、ボブにそれを行わせ、トランザクションの手数料を払わせます。</p>
<p>そのコントラクトは次の様に動作します:</p>
<blockquote>
<div><ol class="arabic simple">
<li>アリスは最終的に行われる支払いをカバーするのに十分な量のEtherを付与した上で <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> コントラクトをデプロイします。</li>
<li>アリスは秘密鍵による署名により支払いを許可します。</li>
<li>アリスは暗号学的に署名されたメッセージをボブに送ります。そのメッセージは隠される必要はありません（後で説明します）し、この送信メカニズムは重要ではありません。</li>
<li>コントラクトに署名されたメッセージを渡すことでボブは支払いを要求します。コントラクトはメッセージの有効性を確認の上、コントラクト上の資金を解放します。</li>
</ol>
</div></blockquote>
<div class="section" id="creating-the-signature">
<h4>Creating the signature<a class="headerlink" href="#creating-the-signature" title="Permalink to this headline">¶</a></h4>
<p>アリスはトランザクションに署名するのにEthereumネットワークに繋げる必要はありません。このプロセスは完全にオフラインで行われます。このチュートリアルでは <a class="reference external" href="https://github.com/ethereum/web3.js">web3.js</a> と <a class="reference external" href="https://metamask.io">MetaMask</a> を使ってブラウザ上で署名を行います。さらに <a class="reference external" href="https://github.com/ethereum/EIPs/pull/712">EIP-762</a> の中のメソッドで、他のセキュリティに関する恩恵を色々得られるメソッドを使用します。</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="c1">/// Hashing first makes things easier</span>
<span class="kd">var</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">web3</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="nf">sha3</span><span class="p">(</span><span class="s">&quot;message to sign&quot;</span><span class="p">);</span>
<span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">personal</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">defaultAccount</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Signed&quot;</span><span class="p">);</span> <span class="p">});</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">web3.eth.personal.sign</span></code> は署名されたデータの長さを表しています。最初にハッシュ化されているため、メッセージは常に32バイトの長さで、この長さの接頭辞は常に同じです。</p>
</div>
</div>
<div class="section" id="what-to-sign">
<h4>What to Sign<a class="headerlink" href="#what-to-sign" title="Permalink to this headline">¶</a></h4>
<p>支払いを行うコントラクトでは署名されたメッセージは下記を含んでいる必要があります。</p>
<blockquote>
<div><ol class="arabic simple">
<li>受領者のアドレス</li>
<li>送金額</li>
<li>リプレイアタックに対する防御策</li>
</ol>
</div></blockquote>
<p>リプレイアタックは署名されたメッセージが承認を要求するのに再び使われることです。これを回避するためにEthereumのトランザクションと同じ様に、アカウントから送信されたトランザクションの数、いわゆるnonceを使用します。スマートコントラクトはnonceが何度か使われていないか確認します。</p>
<p>別のタイプのリプレイアタックはあるオーナーが支払いを行い、その後コントラクトを破棄する <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> というスマートコントラクトをデプロイした時に起こり得ます。その後、オーナーが再び <code class="docutils literal notranslate"><span class="pre">RecipientPays</span></code> をデプロイする時、その新しいコントラクトは前のデプロイでのnonceを知らないので、攻撃者は古いメッセージを再使用することができます。</p>
<p>アリスはメッセージの中にコントラクトのアドレスを含めることによりこの攻撃を防ぐことができます。さらにこの中ではコントラクトのアドレスを含んだメッセージだけが許可されます。このセクションの最後にあるコントラクトの中の <code class="docutils literal notranslate"><span class="pre">claimPayment()</span></code> ファンクションの中の最初の2行でこの例を確認できます。</p>
</div>
<div class="section" id="packing-arguments">
<h4>Packing arguments<a class="headerlink" href="#packing-arguments" title="Permalink to this headline">¶</a></h4>
<p>署名されたメッセージの中にどんな情報を含める必要があるか分かったので、メッセージをまとめ、ハッシュ化し、署名する準備ができました。
シンプルにするためにこのデータを連結させます。
<a class="reference external" href="https://github.com/ethereumjs/ethereumjs-abi">ethereumjs-abi</a> ライブラリは <code class="docutils literal notranslate"><span class="pre">soliditySHA3</span></code> というファンクションを持っています。これは <code class="docutils literal notranslate"><span class="pre">abi.encodePacked</span></code> を使ってエンコードされた引数に適用されたSolidityの <code class="docutils literal notranslate"><span class="pre">keccak256</span></code> と同じ振る舞いをします。以下は <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> で適切な署名を作成するJavaScriptのファンクションの例です。</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="c1">// recipient is the address that should be paid.</span>
<span class="c1">// amount, in wei, specifies how much ether should be sent.</span>
<span class="c1">// nonce can be any unique number to prevent replay attacks</span>
<span class="c1">// contractAddress is used to prevent cross-contract replay attacks</span>
<span class="kd">function</span> <span class="n">signPayment</span><span class="p">(</span><span class="n">recipient</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">contractAddress</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">hash</span> <span class="o">=</span> <span class="s">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">abi</span><span class="p">.</span><span class="n">soliditySHA3</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="s">&quot;uint256&quot;</span><span class="p">,</span> <span class="s">&quot;uint256&quot;</span><span class="p">,</span> <span class="s">&quot;address&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="n">recipient</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">contractAddress</span><span class="p">]</span>
    <span class="p">).</span><span class="n">toString</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">);</span>

    <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">personal</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">defaultAccount</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="recovering-the-message-signer-in-solidity">
<h4>Recovering the Message Signer in Solidity<a class="headerlink" href="#recovering-the-message-signer-in-solidity" title="Permalink to this headline">¶</a></h4>
<p>一般的にECDSA署名は <code class="docutils literal notranslate"><span class="pre">r</span></code> と <code class="docutils literal notranslate"><span class="pre">s</span></code> という2つのパラメータで構成されています。Ethereum上の署名は3つ目のパラメータ <code class="docutils literal notranslate"><span class="pre">v</span></code> を含んでいます。これは署名のどのアカウントの秘密鍵が使われたか、トランザクションの送信者が誰か検証するのに使われます。</p>
<p>Solidityは <code class="docutils literal notranslate"><span class="pre">r</span></code>、<code class="docutils literal notranslate"><span class="pre">s</span></code> そして <code class="docutils literal notranslate"><span class="pre">v</span></code> パラメータと一緒にメッセージを受け入れるビルトインファンクションの <a class="reference external" href="mathematical-and-cryptographic-functions">ecrecover</a> を持っています。さらにこのファンクションはメッセージに署名したアドレスを返します。</p>
</div>
<div class="section" id="extracting-the-signature-parameters">
<h4>Extracting the Signature Parameters<a class="headerlink" href="#extracting-the-signature-parameters" title="Permalink to this headline">¶</a></h4>
<p>web3.jsでされた署名は <code class="docutils literal notranslate"><span class="pre">r</span></code>、<code class="docutils literal notranslate"><span class="pre">s</span></code>、<code class="docutils literal notranslate"><span class="pre">v</span></code> が連結されたものなので、最初のステップはこれをそれぞれに分けることです。これはクライアント側でもできますが、スマートコントラクト内ですれば1つのパラメータだけで済みます。バイト配列を要素ごとに分けるのは見た目があまり良くないので、<code class="docutils literal notranslate"><span class="pre">splitSignature</span></code> ファンクション（セクションの最後のフルコントラクトの3番目のファンクション）内でこの操作を行うために <a class="reference external" href="assembly">inline assembly</a> を使用します。</p>
</div>
<div class="section" id="computing-the-message-hash">
<h4>Computing the Message Hash<a class="headerlink" href="#computing-the-message-hash" title="Permalink to this headline">¶</a></h4>
<p>スマートコントラクトはどのパラメータがサインされたか知る必要あるので、スマートコントラクトはパラメータをメッセージから再作成し、それを署名の認証に使わなければならない。<code class="docutils literal notranslate"><span class="pre">prefixed</span></code> と <code class="docutils literal notranslate"><span class="pre">recoverSigner</span></code> ファンクションは <code class="docutils literal notranslate"><span class="pre">claimPayment</span></code> ファンクションの中でこれを行う。</p>
</div>
<div class="section" id="the-full-contract">
<h4>The full contract<a class="headerlink" href="#the-full-contract" title="Permalink to this headline">¶</a></h4>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">24</span> <span class="o">&lt;</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">ReceiverPays</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>

    <span class="kd">mapping</span><span class="p">(</span><span class="kt">uint256</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="n">usedNonces</span><span class="p">;</span>

    <span class="kd">constructor</span><span class="p">()</span> <span class="kr">public</span> <span class="kr">payable</span> <span class="p">{}</span>

    <span class="kd">function</span> <span class="n">claimPayment</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">nonce</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">signature</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="o">!</span><span class="n">usedNonces</span><span class="p">[</span><span class="n">nonce</span><span class="p">]);</span>
        <span class="n">usedNonces</span><span class="p">[</span><span class="n">nonce</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="c1">// this recreates the message that was signed on the client</span>
        <span class="kt">bytes32</span> <span class="n">message</span> <span class="o">=</span> <span class="n">prefixed</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="nb">this</span><span class="p">)));</span>

        <span class="nf">require</span><span class="p">(</span><span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">owner</span><span class="p">);</span>

        <span class="nb">msg.sender</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// destroy the contract and reclaim the leftover funds.</span>
    <span class="kd">function</span> <span class="n">kill</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">owner</span><span class="p">);</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="nb">msg.sender</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// signature methods.</span>
    <span class="kd">function</span> <span class="n">splitSignature</span><span class="p">(</span><span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">65</span><span class="p">);</span>

        <span class="k">assembly</span> <span class="p">{</span>
            <span class="c1">// first 32 bytes, after the length prefix.</span>
            <span class="n">r</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
            <span class="c1">// second 32 bytes.</span>
            <span class="n">s</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>
            <span class="c1">// final byte (first byte of the next 32 bytes).</span>
            <span class="n">v</span> <span class="o">:=</span> <span class="nf">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">96</span><span class="p">)))</span>
        <span class="p">}</span>

        <span class="nf">return</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="err">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">message</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitSignature</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">ecrecover</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// builds a prefixed hash to mimic the behavior of eth_sign.</span>
    <span class="kd">function</span> <span class="n">prefixed</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">hash</span><span class="p">)</span> <span class="kr">internal</span> <span class="kr">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x19</span><span class="s">Ethereum Signed Message:</span><span class="se">\n</span><span class="s">32&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-a-simple-payment-channel">
<h3>Writing a Simple Payment Channel<a class="headerlink" href="#writing-a-simple-payment-channel" title="Permalink to this headline">¶</a></h3>
<p>アリスは今、シンプルだけど完全なペイメントチャンネルを作っている。ペイメントチャンネルは繰り返されるEtherのやり取りを安全、即時、かつトランザクション手数料なしで行うため、暗号学的な署名を使用している。アリスとボブによるシンプルな間接的ペイメントチャンネルを考えてみましょう。</p>
<div class="section" id="what-is-a-payment-channel">
<h4>What is a Payment Channel?<a class="headerlink" href="#what-is-a-payment-channel" title="Permalink to this headline">¶</a></h4>
<p>ペイメントチャンネルは参加者にトランザクションを使用しないで何度もEtherのやり取りをできる様にしています。つまりトランザクションに関わる遅れや手数料が発生しないということです。</p>
<blockquote>
<div><ol class="arabic simple">
<li>アリスはあるコントラクトにEtherでお金を入れました。これでペイメントチャンネルが”開きます”。</li>
<li>アリスは何Etherが受領者に受け渡されるか書いてあるメッセージに署名しました。このステップは支払いごとに繰り返されます。</li>
<li>ボブは支払われたEtherを引き出し、残りを送金者に返しペイメントチャンネルを”閉じました”。</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>ステップ1と3だけトランザクションが必要で、ステップ2では送金者が受領者にオフチェーンの方法（例えばEmail）で署名されたメッセージを送っているということです。つまりたった2つのトランザクションだけでいくらでも送金が行えるということです。</p>
<p class="last">スマートコントラクトがエスクロー（第三者信託）としてEtherを扱い、そして有効に署名されたメッセージを引き受けているため、ボブはファンドされたお金を受け取れることが保証されています。スマートコントラクトは二人のペイメントチャンネルのタイムアウトを行うこともできるので、アリスは受領者がチャンネルのクローズを拒否してもお金が戻ってくることが保証されています。どのくらいペイメントチャンネルを開いておくかは参加者が決めることができます。短い期間のトランザクションでは例えばインターネットカフェで分ごとに課金される仕組みであったり、もっと長いもので言えば、時給で働く従業員への支払いに使えますし、ペイメントチャンネルは何ヶ月、何年もオープンにしておくことができます。</p>
</div>
</div>
<div class="section" id="opening-the-payment-channel">
<h4>Opening the Payment Channel<a class="headerlink" href="#opening-the-payment-channel" title="Permalink to this headline">¶</a></h4>
<p>ペイメントチャンネルを開くためにアリスはスマートコントラクトをデプロイしました。そのスマートコントラクトにはエスクローされるEtherを渡し、受領者とチャンネルの最大存続期間を決めました。これはこのセクションの最後にあるコントラストの中の <code class="docutils literal notranslate"><span class="pre">SimplePaymentChannel</span></code> ファンクションに入っています。</p>
</div>
<div class="section" id="making-payments">
<h4>Making Payments<a class="headerlink" href="#making-payments" title="Permalink to this headline">¶</a></h4>
<p>アリスはボブに署名されたメッセージを送ることで支払いを行います。このステップは完全にEthereumネットワークの外側で行われます。
メッセージは送信者により暗号化された署名が行われ、受領者に直接送られます。</p>
<dl class="docutils">
<dt>それぞれのメッセージは以下の情報を含んでいます。</dt>
<dd><ul class="first last simple">
<li>スマートコントラクトのアドレス（クロスコントラクト攻撃を防ぐため）</li>
<li>現状受領者が受け取っているEtherの総額</li>
</ul>
</dd>
</dl>
<p>ペイメントチャンネルは幾度と行われる送金の最後に一度だけクローズされます。
このため送られたメッセージの内、1つだけが履行されます。これが各マイクロペイメントの額ではなく累積額をメッセージにのせている理由です。最新のメッセージが最高額が書いてあるので、受領者は自然にそのメッセージを履行します。
スマートコントラクトは1つのメッセージだけを受け入れるため、メッセージごとのナンスはもう必要ありません。意図していた以外の他のチャンネルによって使われない様に、このスマートコントラクトのアドレスは使われたままです。</p>
<p>以下にメッセージに暗号学的に署名した前回のセクションから修正したJavaScriptを示します。</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="n">constructPaymentMessage</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">abi</span><span class="p">.</span><span class="n">soliditySHA3</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="s">&quot;uint256&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">]</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">signMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">personal</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span>
        <span class="s">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">),</span>
        <span class="n">web3</span><span class="p">.</span><span class="n">eth</span><span class="p">.</span><span class="n">defaultAccount</span><span class="p">,</span>
        <span class="n">callback</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// contractAddress is used to prevent cross-contract replay attacks.</span>
<span class="c1">// amount, in wei, specifies how much Ether should be sent.</span>

<span class="kd">function</span> <span class="n">signPayment</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">message</span> <span class="o">=</span> <span class="n">constructPaymentMessage</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="n">signMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="closing-the-payment-channel">
<h4>Closing the Payment Channel<a class="headerlink" href="#closing-the-payment-channel" title="Permalink to this headline">¶</a></h4>
<p>ボブがチャンネルにあるお金を受け取る準備ができた時、スマートコントラクト内の <code class="docutils literal notranslate"><span class="pre">close</span></code> ファンクションを呼び出し、チャンネルをクローズする時間です。
チャンネルを閉じるときに、受領者に彼らがチャンネルに渡したEtherが支払われ、コントラクトは破棄されます。残っているEtherはアリスに返却されます。チャンネルを閉じるために、ボブはアリスによってサインされたメッセージを提供する必要があります。</p>
<p>スマートコントラクトはそのメッセージに送信者からの有効な署名がなされているか検証しなければなりません。この検証プロセスの目的は受領者が使うプロセスと同じです。このセクションの最後にあるSolidityの <code class="docutils literal notranslate"><span class="pre">isValidSignature</span></code> と <code class="docutils literal notranslate"><span class="pre">recoverSigner</span></code> ファンクションは <code class="docutils literal notranslate"><span class="pre">ReceiverPays</span></code> コントラクトから借りてきたファンクションと共に、これらに対応する前セクションのJavascriptのファンクションと同様な動きをします。</p>
<p>一番最近のペイメントのメッセージを送ったペイメントチャンネルの受領者のみが <code class="docutils literal notranslate"><span class="pre">close</span></code> ファンクションを呼ぶことができます。なぜならそのメッセージが一番高い合計の金額を持っているからです。もし送信者がこのファンクションを呼ぶ権限を持っていると、その送信者が低い総額のメッセージを作って、受領者が受け取るべき金額を改ざんできてしまいます。</p>
<p>そのファンクションは署名されたメッセージが与えられたパラメータと合っているか検証します。全ての検証が通ったら、受領者は取り分のEtherを受け取り、送信者が <code class="docutils literal notranslate"><span class="pre">selfdestruct</span></code> を通じて残りを受け取ります。フルコントラクト内で <code class="docutils literal notranslate"><span class="pre">close</span></code> ファンクションは見ることができます。</p>
</div>
<div class="section" id="channel-expiration">
<h4>Channel Expiration<a class="headerlink" href="#channel-expiration" title="Permalink to this headline">¶</a></h4>
<p>ボブはペイメントチャンネルをいつでも閉じることができます。しかしチャンネルが閉じられなかった場合、アリスは第三者預託されたお金を回収する方法が必要になります。コントラクトのデプロイ時にコントラクトの失効期日がセットされます。その日になると、アリスはお金を回収するために <code class="docutils literal notranslate"><span class="pre">claimTimeout</span></code> を呼ぶことができます。<code class="docutils literal notranslate"><span class="pre">claimTimeout</span></code> ファンクションはフルコントラクト内で確認できます。</p>
</div>
<div class="section" id="id3">
<h4>The full contract<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">24</span> <span class="o">&lt;</span><span class="mf">0.6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">SimplePaymentChannel</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">sender</span><span class="p">;</span>      <span class="c1">// The account sending payments.</span>
    <span class="kt">address</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="n">recipient</span><span class="p">;</span>   <span class="c1">// The account receiving the payments.</span>
    <span class="kt">uint256</span> <span class="kr">public</span> <span class="n">expiration</span><span class="p">;</span>  <span class="c1">// Timeout in case the recipient never closes.</span>

    <span class="kd">constructor</span> <span class="p">(</span><span class="kt">address</span> <span class="kr">payable</span> <span class="n">_recipient</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">duration</span><span class="p">)</span>
        <span class="kr">public</span>
        <span class="kr">payable</span>
    <span class="p">{</span>
        <span class="n">sender</span> <span class="o">=</span> <span class="nb">msg.sender</span><span class="p">;</span>
        <span class="n">recipient</span> <span class="o">=</span> <span class="n">_recipient</span><span class="p">;</span>
        <span class="n">expiration</span> <span class="o">=</span> <span class="nb">now</span> <span class="o">+</span> <span class="n">duration</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">isValidSignature</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">signature</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">view</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">bytes32</span> <span class="n">message</span> <span class="o">=</span> <span class="n">prefixed</span><span class="p">(</span><span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="nb">this</span><span class="p">,</span> <span class="n">amount</span><span class="p">)));</span>

        <span class="c1">// check that the signature is from the payment sender</span>
        <span class="k">return</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span> <span class="o">==</span> <span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// the recipient can close the channel at any time by presenting a</span>
    <span class="c1">/// signed amount from the sender. the recipient will be sent that amount,</span>
    <span class="c1">/// and the remainder will go back to the sender</span>
    <span class="kd">function</span> <span class="n">close</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">signature</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">recipient</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">isValidSignature</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">signature</span><span class="p">));</span>

        <span class="n">recipient</span><span class="p">.</span><span class="nf">transfer</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// the sender can extend the expiration at any time</span>
    <span class="kd">function</span> <span class="n">extend</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">newExpiration</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">msg.sender</span> <span class="o">==</span> <span class="n">sender</span><span class="p">);</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">newExpiration</span> <span class="o">&gt;</span> <span class="n">expiration</span><span class="p">);</span>

        <span class="n">expiration</span> <span class="o">=</span> <span class="n">newExpiration</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">/// if the timeout is reached without the recipient closing the channel,</span>
    <span class="c1">/// then the Ether is released back to the sender.</span>
    <span class="kd">function</span> <span class="n">claimTimeout</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&gt;=</span> <span class="n">expiration</span><span class="p">);</span>
        <span class="nb">selfdestruct</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// All functions below this are just taken from the chapter</span>
    <span class="c1">/// &#39;creating and verifying signatures&#39; chapter.</span>

    <span class="kd">function</span> <span class="n">splitSignature</span><span class="p">(</span><span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nf">require</span><span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">65</span><span class="p">);</span>

        <span class="k">assembly</span> <span class="p">{</span>
            <span class="c1">// first 32 bytes, after the length prefix</span>
            <span class="n">r</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
            <span class="c1">// second 32 bytes</span>
            <span class="n">s</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>
            <span class="c1">// final byte (first byte of the next 32 bytes)</span>
            <span class="n">v</span> <span class="o">:=</span> <span class="nf">byte</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">96</span><span class="p">)))</span>
        <span class="p">}</span>

        <span class="nf">return</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="err">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">message</span><span class="p">,</span> <span class="kt">bytes</span> <span class="kr">memory</span> <span class="n">sig</span><span class="p">)</span>
        <span class="kr">internal</span>
        <span class="kr">pure</span>
        <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="kt">uint8</span> <span class="n">v</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">splitSignature</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">ecrecover</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">/// builds a prefixed hash to mimic the behavior of eth_sign.</span>
    <span class="kd">function</span> <span class="n">prefixed</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">hash</span><span class="p">)</span> <span class="kr">internal</span> <span class="kr">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">keccak256</span><span class="p">(</span><span class="nb">abi.encodePacked</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x19</span><span class="s">Ethereum Signed Message:</span><span class="se">\n</span><span class="s">32&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">splitSignature</span></code> ファンクションは全てのセキュリティチェックを使いません。本当の実行時にはもっと厳しくテストされたopenzepplin’s <a class="reference external" href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/master/contracts/ECRecovery.sol">version</a> の様なライブラリを使用するべきです。</p>
</div>
</div>
<div class="section" id="verifying-payments">
<h4>Verifying Payments<a class="headerlink" href="#verifying-payments" title="Permalink to this headline">¶</a></h4>
<p>前のセクションとは違い、ペイメントチャンネル内のメッセージはすぐには履行されません。受領者が最新のメッセージを確認し続け、ペイメントチャンネルを閉じるときにそのメッセージを履行します。つまり受領者が各メッセージの検証をすることが重要ということです。
そうしないと、受領者が最終的にお金を受け取れる保証がされなくなります。</p>
<p>受領者は下記のプロセスで各メッセージを検証すべきです。</p>
<blockquote>
<div><ol class="arabic simple">
<li>メッセージの中のコントラクトアドレスがペイメントチャンネルと合っているか検証してください。</li>
<li>新しい総額が予定していたものと同じか検証してください。</li>
<li>新しい総額が第三者預託されたEtherを超えていないか検証してください。</li>
<li>署名が有効か、そしてペイメントチャンネルの送信者からのものか検証してください。</li>
</ol>
</div></blockquote>
<p>この検証を記載するために <a class="reference external" href="https://github.com/ethereumjs/ethereumjs-util">ethereumjs-util</a> ライブラリを使用します。最終ステップは色々な方法で行うことができますが、ここではJavaScriptを使用します。次のコードは上記の <strong>JavaScriptコード</strong> の署名から <cite>constructMessage</cite> ファンクションを借りています。</p>
<div class="highlight-Solidity notranslate"><div class="highlight"><pre><span></span><span class="c1">// this mimics the prefixing behavior of the eth_sign JSON-RPC method.</span>
<span class="kd">function</span> <span class="n">prefixed</span><span class="p">(</span><span class="n">hash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">ABI</span><span class="p">.</span><span class="n">soliditySHA3</span><span class="p">(</span>
        <span class="p">[</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="s">&quot;bytes32&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s">&quot;</span><span class="se">\x19</span><span class="s">Ethereum Signed Message:</span><span class="se">\n</span><span class="s">32&quot;</span><span class="p">,</span> <span class="n">hash</span><span class="p">]</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">split</span> <span class="o">=</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="n">fromRpcSig</span><span class="p">(</span><span class="n">signature</span><span class="p">);</span>
    <span class="kd">var</span> <span class="n">publicKey</span> <span class="o">=</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="nf">ecrecover</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">split</span><span class="p">.</span><span class="n">v</span><span class="p">,</span> <span class="n">split</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">split</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>
    <span class="kd">var</span> <span class="n">signer</span> <span class="o">=</span> <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="n">pubToAddress</span><span class="p">(</span><span class="n">publicKey</span><span class="p">).</span><span class="n">toString</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">signer</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">isValidSignature</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">expectedSigner</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">message</span> <span class="o">=</span> <span class="n">prefixed</span><span class="p">(</span><span class="n">constructPaymentMessage</span><span class="p">(</span><span class="n">contractAddress</span><span class="p">,</span> <span class="n">amount</span><span class="p">));</span>
    <span class="kd">var</span> <span class="n">signer</span> <span class="o">=</span> <span class="n">recoverSigner</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">signature</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">signer</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">()</span> <span class="o">==</span>
        <span class="n">ethereumjs</span><span class="p">.</span><span class="n">Util</span><span class="p">.</span><span class="n">stripHexPrefix</span><span class="p">(</span><span class="n">expectedSigner</span><span class="p">).</span><span class="n">toLowerCase</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="solidity-in-depth.html" class="btn btn-neutral float-right" title="Solidity in Depth" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installing-solidity.html" class="btn btn-neutral float-left" title="Installing the Solidity Compiler" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2019, Ethereum

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>